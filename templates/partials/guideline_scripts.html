<script>
    let currentMode = 'classic';
    let currentFiles = {};
    let currentTemplate = null;
    let templateVariables = {};
        const NOTEBOOK_API = '/api/v3/notebook'; // TODO: đổi sang endpoint thật khi backend sẵn sàng
    const NOTEBOOK_HEADERS = {
        'Authorization': 'Bearer YOUR_API_KEY_HERE'
    };
    let notebookSources = [];
    let notebookSelectedSourceIds = new Set();
    let notebookMessages = [];
    let notebookStudioAction = null;

    function clearGuidelineStatus() {
        const status = document.getElementById('guidelineStatus');
        if (status) {
            status.textContent = '';
            status.className = 'status hidden';
        }
        const download = document.getElementById('guidelineDownloadSection');
        if (download) {
            download.classList.add('hidden');
        }
        const link = document.getElementById('guidelineDownloadLink');
        if (link) {
            link.href = '#';
            link.textContent = '⬇️ Tải file kết quả';
            link.removeAttribute('download');
        }
    }

    function showGuidelineStatus(message, type = 'info') {
        const status = document.getElementById('guidelineStatus');
        if (!status) return;
        status.textContent = message;
        status.className = `status ${type}`;
    }

    function handleGuidelineSuccess(result) {
        showGuidelineStatus('✓ Chuyển đổi Guideline thành công!', 'success');
        const download = document.getElementById('guidelineDownloadSection');
        const link = document.getElementById('guidelineDownloadLink');
        if (download && link && result.download_url) {
            const fileName = result.file_saved || 'output.md';
            link.href = result.download_url;
            link.setAttribute('download', fileName);
            link.textContent = `⬇️ Tải ${fileName}`;
            download.classList.remove('hidden');
        }
    }

    function resetGuidelineFlow() {
        clearGuidelineStatus();
        currentTemplate = null;
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        const formatInput = document.getElementById('formatTextPreview');
        if (formatInput) {
            formatInput.value = '';
        }
        const formattingResult = document.getElementById('formattingResult');
        if (formattingResult) {
            formattingResult.classList.add('hidden');
        }
        const formattingPreview = document.getElementById('formattingPreview');
        if (formattingPreview) {
            formattingPreview.innerHTML = '';
        }
    }

    function updateGuidelineFileInfo(inputId, infoId) {
        const input = document.getElementById(inputId);
        const info = document.getElementById(infoId);
        if (!input || !info || !input.files || input.files.length === 0) {
            if (info) {
                info.textContent = '';
                info.classList.add('hidden');
            }
            return false;
        }
        const file = input.files[0];
        const sizeKb = (file.size / 1024).toFixed(1);
        info.textContent = `✓ ${file.name} (${sizeKb} KB)`;
        info.classList.remove('hidden');
        return true;
    }

    function setupGuidelineUploadArea(areaId, inputId) {
        const area = document.getElementById(areaId);
        const input = document.getElementById(inputId);
        if (!area || !input) return;

        area.addEventListener('click', () => input.click());

        let dragCounter = 0;
        area.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            area.classList.add('dragover');
        });
        area.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                area.classList.remove('dragover');
            }
        });
        area.addEventListener('dragover', (e) => e.preventDefault());
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            area.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            }
        });
    }
    function clearConvertStatuses() {
        const status = document.getElementById('conversionStatus');
        if (status) {
            status.innerHTML = '';
            status.className = 'status hidden';
        }
        const statusMsg = document.getElementById('statusMsg');
        if (statusMsg) {
            statusMsg.textContent = '';
            statusMsg.className = 'status hidden';
        }
        const downloadSection = document.getElementById('downloadSection');
        if (downloadSection) {
            downloadSection.classList.add('hidden');
        }
    }
    const modeCopy = {
        classic: {
            label: 'Excel Classic',
            desc: 'Tối ưu cho Excel → DOCX.',
            title: 'Excel Classic',
            subtitle: 'Chuyển đổi Excel theo từng bước chi tiết.',
            showSource: true,
            showTarget: true
        },
        universal: {
            label: 'Universal',
            desc: 'Chuyển nhiều định dạng sang Markdown nhanh.',
            title: 'Universal',
            subtitle: 'Chuyển file bất kỳ định dạng sang Markdown.',
            showSource: false,
            showTarget: false
        }
    };

    function ensureConvertContent() {
        const convertScreen = document.getElementById('convertScreen');
        if (!convertScreen || convertScreen.classList.contains('hidden')) {
            return;
        }
        const activeSection = convertScreen.querySelector('.mode-section.active:not(.hidden)');
        if (!activeSection) {
            const fallback = currentMode && modeCopy[currentMode] ? currentMode : 'classic';
            switchMode(fallback);
        }
    }

    function setActiveScreen(screenId) {
        const screens = ['homeScreen', 'modeSelectScreen', 'convertScreen', 'guidelineScreen'];
        screens.forEach(id => {
            const screen = document.getElementById(id);
            if (!screen) {
                return;
            }
            const isActive = id === screenId;
            screen.classList.toggle('active', isActive);
            screen.classList.toggle('hidden', !isActive);
        });
        if (screenId === 'convertScreen') {
            ensureConvertContent();
        }
    }

    function openHome() {
        currentMode = null;
        clearConvertStatuses();
        clearGuidelineStatus();
        setActiveScreen('homeScreen');
    }

    function openModeSelect() {
        setActiveScreen('modeSelectScreen');
    }

    function openConvertFlow(mode) {
        const targetMode = modeCopy[mode] ? mode : 'classic';
        currentMode = targetMode;
        clearConvertStatuses();
        setActiveScreen('convertScreen');
        switchMode(targetMode);
    }

    function openGuidelineAi(tab = 'guideline') {
        setActiveScreen('guidelineScreen');
        switchGuidelineTab(tab === 'notebook' ? 'notebook' : 'guideline');
    }

    function updateConvertLabels(mode) {
        const copy = modeCopy[mode] || modeCopy.classic;
        const label = document.getElementById('activeModeLabel');
        const desc = document.getElementById('activeModeDesc');
        const flowTitle = document.getElementById('convertFlowTitle');
        const flowSubtitle = document.getElementById('convertFlowSubtitle');
        const headerTitle = document.getElementById('convertTitle');
        const headerSubtitle = document.getElementById('convertSubtitle');
        const sourceGroup = document.getElementById('sourceFormatGroup');
        const targetGroup = document.getElementById('targetFormatGroup');

        if (label) {
            label.textContent = copy.label;
        }
        if (desc) {
            desc.textContent = copy.desc;
        }
        if (flowTitle) {
            flowTitle.textContent = copy.title;
        }
        if (flowSubtitle) {
            flowSubtitle.textContent = copy.subtitle;
        }
        if (headerTitle) {
            headerTitle.textContent = copy.title;
        }
        if (headerSubtitle) {
            headerSubtitle.textContent = copy.subtitle;
        }
        if (sourceGroup) {
            sourceGroup.classList.toggle('hidden', !copy.showSource);
        }
        if (targetGroup) {
            targetGroup.classList.toggle('hidden', !copy.showTarget);
        }
    }

    function switchGuidelineTab(target) {
        const notebookModeEl = document.getElementById('notebookMode');
        if (notebookModeEl) {
            notebookModeEl.classList.add('active');
            notebookModeEl.classList.remove('hidden');
        }
        clearGuidelineStatus();
    }

    function switchMode(mode) {
        if (mode === 'guideline' || mode === 'custom') {
            openGuidelineAi(mode);
            return;
        }

        currentMode = modeCopy[mode] ? mode : 'classic';
        clearConvertStatuses();
        
        document.querySelectorAll('.mode-section').forEach(el => {
            el.classList.remove('active');
            el.classList.add('hidden');
        });
        
        const modeId = currentMode + 'Mode';
        let modeElement = document.getElementById(modeId);
        if (!modeElement) {
            currentMode = 'classic';
            modeElement = document.getElementById('classicMode');
        }
        if (modeElement) {
            modeElement.classList.add('active');
            modeElement.classList.remove('hidden');
        }

        updateConvertLabels(currentMode);
    }

    function goToStep(stepId) {
        const container = document.getElementById('guidelineMode');
        if (!container) return;
        container.querySelectorAll('.step').forEach(el => {
            el.classList.remove('active');
        });
        const step = container.querySelector('#' + stepId);
        if (step) step.classList.add('active');
    }

    function handleGuidelineFileInput() {
        const input = document.getElementById('guidelineFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        if (!updateGuidelineFileInfo('guidelineFileInput', 'guidelineFileInfo')) {
            return;
        }
        resetGuidelineFlow();
        currentFiles.guideline = file;
        goToStep('guideline-step-2');
    }

    function handleCustomFileInput() {
        const input = document.getElementById('customFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        currentFiles.custom = file;
        goToStep('custom-step-2');
    }

    function selectTemplate(templateType, el) {
        currentTemplate = templateType;
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        el.classList.add('selected');
    }

    async function previewGuidelineFormatting() {
        const text = document.getElementById('formatTextPreview').value;
        if (!text) {
            alert('Vui lòng nhập text để xem preview');
            return;
        }

        try {
            const response = await fetch('/api/v2/format/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(text)
            });

            if (!response.ok) {
                throw new Error('Lỗi định dạng text');
            }

            const result = await response.json();
            const preview = document.getElementById('formattingPreview');
            preview.innerHTML = marked.parse(result.formatted_text);
            document.getElementById('formattingResult').classList.remove('hidden');
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        }
    }

    async function convertWithGuideline() {
        if (!currentFiles.guideline) {
            alert('Vui lòng chọn file');
            return;
        }

        if (!currentTemplate) {
            alert('Vui lòng chọn loại template');
            return;
        }

        clearGuidelineStatus();
        showLoadingOverlay(true, `Đang chuyển đổi với Template ${currentTemplate}...`);

        try {
            const uploadForm = new FormData();
            uploadForm.append('file', currentFiles.guideline);

            const uploadResponse = await fetch('/api/v2/upload', {
                method: 'POST',
                body: uploadForm
            });

            const uploadData = await uploadResponse.json();
            if (!uploadResponse.ok) {
                const detail = uploadData.detail || uploadData.error || 'Lỗi upload';
                throw new Error(detail);
            }

            const response = await fetch('/api/v2/convert/guideline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: uploadData.filename,
                    template_type: currentTemplate
                })
            });

            const result = await response.json();
            if (!response.ok) {
                const detail = result.detail || result.error || 'Lỗi chuyển đổi';
                throw new Error(detail);
            }

            handleGuidelineSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            showGuidelineStatus('Lỗi: ' + error.message, 'error');
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function loadPredefinedTemplate() {
        const select = document.getElementById('predefinedTemplateSelect') || document.getElementById('customTemplateSelect');
        if (!select) {
            return;
        }
        const templateKey = select.value;

        if (!templateKey) {
            document.getElementById('customTemplate').value = '';
            return;
        }

        try {
            const response = await fetch(`/api/v2/predefined-template?template_type=${templateKey}`);
            if (!response.ok) {
                throw new Error('Không thể tải template');
            }

            const result = await response.json();
            document.getElementById('customTemplate').value = result.template;
            extractVariablesFromTemplate(result.template);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        }
    }

    function extractVariablesFromTemplate(template) {
        const variableRegex = /\{\{([A-Z_]+)\}\}/g;
        const variables = new Set();
        let match;

        while ((match = variableRegex.exec(template)) !== null) {
            variables.add(match[1]);
        }

        templateVariables = {};
        variables.forEach(v => {
            templateVariables[v] = '';
        });

        renderVariablesInputs();
    }

    function renderVariablesInputs() {
        const container = document.getElementById('variablesInputs');
        container.innerHTML = '';

        const listContainer = document.getElementById('variablesList');
        listContainer.innerHTML = '';
        Object.keys(templateVariables).forEach(varName => {
            const tag = document.createElement('span');
            tag.className = 'variable-tag';
            tag.textContent = '{{' + varName + '}}';
            listContainer.appendChild(tag);
        });

        Object.keys(templateVariables).forEach(varName => {
            const group = document.createElement('div');
            group.className = 'variable-input-group';
            group.innerHTML = '<label for="var_' + varName + '">{{' + varName + '}}</label>' +
                '<textarea id="var_' + varName + '" placeholder="Nhập giá trị cho ' + varName + '"></textarea>';
            container.appendChild(group);
        });
    }

    async function convertWithCustomTemplate() {
        if (!currentFiles.custom) {
            alert('Vui lòng chọn file');
            return;
        }

        const templateText = document.getElementById('customTemplate').value;
        if (!templateText) {
            alert('Vui lòng nhập hoặc chọn template');
            return;
        }

        const variables = {};
        Object.keys(templateVariables).forEach(varName => {
            const input = document.getElementById('var_' + varName);
            if (input) {
                variables[varName] = input.value || '';
            }
        });

        const formData = new FormData();
        formData.append('file', currentFiles.custom);
        formData.append('template', templateText);
        formData.append('variables', JSON.stringify(variables));
        formData.append('apply_guideline', document.getElementById('applyGuidelineFormatting').checked);

        showLoadingOverlay(true, 'Đang chuyển đổi với Custom Template...');

        try {
            const response = await fetch('/api/v2/convert-with-custom-template', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Lỗi chuyển đổi');
            }

            const result = await response.json();
            handleConversionSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        } finally {
            showLoadingOverlay(false);
        }
    }

    // ===== NotebookLM-style workspace helpers =====
    function createNotebookId(prefix = 'nb') {
        return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 6)}`;
    }

    function escapeHtml(text) {
        return (text || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function formatNotebookText(text) {
        return escapeHtml(text).replace(/\n/g, '<br/>');
    }

    function updateNotebookSelectedLabel() {
        const label = document.getElementById('notebookSelectedSources');
        const hint = document.getElementById('notebookSelectionHint');
        const count = notebookSelectedSourceIds.size;
        if (label) {
            label.textContent = `${count} nguồn đang chọn`;
        }
        if (hint) {
            hint.textContent = count > 0 ? `${count} nguồn` : 'Chọn nguồn';
        }
    }

    function renderNotebookSources() {
        const list = document.getElementById('notebookSourcesList');
        const countLabel = document.getElementById('notebookSourceCount');

        if (!list) return;

        if (notebookSources.length === 0) {
            list.classList.add('empty');
            list.innerHTML = `
                <div class="empty-state">
                    <p>Chưa có nguồn nào.</p>
                    <small>Thêm file hoặc link để bắt đầu.</small>
                </div>
            `;
        } else {
            list.classList.remove('empty');
            list.innerHTML = notebookSources.map(src => `
                <div class="source-card">
                    <input type="checkbox" class="source-checkbox" data-source-id="${src.id}" onchange="toggleNotebookSource(this)" ${notebookSelectedSourceIds.has(src.id) ? 'checked' : ''}>
                    <div class="source-meta">
                        <div class="source-title">${escapeHtml(src.title || 'Nguồn')}</div>
                        <div class="source-detail">${escapeHtml(src.detail || '')}</div>
                        <div class="source-tags">
                            <span class="source-tag">${escapeHtml(src.type || 'file')}</span>
                            ${src.ref ? `<span class="source-tag">ID: ${escapeHtml(src.ref)}</span>` : ''}
                        </div>
                    </div>
                    <button class="source-remove" type="button" onclick="removeNotebookSource('${src.id}')">×</button>
                </div>
            `).join('');
        }

        if (countLabel) {
            countLabel.textContent = `${notebookSources.length} nguồn`;
        }
        updateNotebookSelectedLabel();
    }

    function addNotebookSource(source) {
        const normalized = {
            id: source.id || createNotebookId('src'),
            title: source.title || 'Nguồn mới',
            detail: source.detail || '',
            type: source.type || 'file',
            ref: source.ref || '',
        };
        notebookSources = [normalized, ...notebookSources.filter(s => s.id !== normalized.id)];
        notebookSelectedSourceIds.add(normalized.id);
        renderNotebookSources();
    }

    function removeNotebookSource(id) {
        notebookSources = notebookSources.filter(s => s.id !== id);
        notebookSelectedSourceIds.delete(id);
        renderNotebookSources();
    }

    function toggleNotebookSource(el) {
        const id = el.dataset.sourceId;
        if (!id) return;
        if (el.checked) {
            notebookSelectedSourceIds.add(id);
        } else {
            notebookSelectedSourceIds.delete(id);
        }
        updateNotebookSelectedLabel();
    }

    async function addNotebookLinkSource() {
        const input = document.getElementById('notebookLinkInput');
        if (!input) return;
        const value = (input.value || '').trim();
        if (!value) {
            alert('Vui lòng nhập link hoặc mô tả nguồn');
            return;
        }
        addNotebookSource({
            title: value.slice(0, 60),
            detail: 'Nguồn web / ghi chú',
            type: 'link',
            ref: value
        });
        input.value = '';
    }

    async function addNotebookWebSearch() {
        const input = document.getElementById('notebookWebQuery');
        if (!input) return;
        const value = (input.value || '').trim();
        if (!value) {
            alert('Nhập từ khóa tìm kiếm');
            return;
        }
        addNotebookSource({
            title: value,
            detail: 'Truy vấn web (mock)',
            type: 'web-search'
        });
        input.value = '';
    }

    async function handleNotebookFileChange(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        showLoadingOverlay(true, 'Đang tải nguồn...');
        try {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetch('/api/v2/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) {
                    const detail = data.detail || data.error || 'Lỗi upload nguồn';
                    throw new Error(detail);
                }
                addNotebookSource({
                    title: file.name,
                    detail: `${data.file_size} • ${data.filename}`,
                    type: 'file',
                    ref: data.filename
                });
            }
        } catch (err) {
            alert('Lỗi thêm nguồn: ' + err.message);
        } finally {
            event.target.value = '';
            showLoadingOverlay(false);
        }
    }

    function selectedNotebookSources() {
        return Array.from(notebookSelectedSourceIds)
            .map(id => notebookSources.find(s => s.id === id))
            .filter(Boolean);
    }

    function insertSourceContext() {
        const prompt = document.getElementById('notebookPrompt');
        if (!prompt) return;
        const sources = selectedNotebookSources();
        if (sources.length === 0) {
            alert('Chọn ít nhất một nguồn để chèn vào prompt');
            return;
        }
        const context = sources.map(s => `- ${s.title} (${s.type}) ${s.ref ? '[' + s.ref + ']' : ''}`).join('\n');
        prompt.value = `${prompt.value ? prompt.value + '\n' : ''}Nguồn tham chiếu:\n${context}\n`;
        prompt.focus();
    }

    function appendNotebookMessage(role, content, meta = {}) {
        notebookMessages.push({
            id: createNotebookId('msg'),
            role,
            content: content || '',
            meta,
            time: new Date()
        });
        renderNotebookMessages();
    }

    function renderNotebookMessages() {
        const container = document.getElementById('notebookMessages');
        if (!container) return;

        if (notebookMessages.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>Thêm nguồn để bắt đầu.</p>
                    <small>Assistant sẽ trả lời dựa trên nguồn đã chọn.</small>
                </div>
            `;
            return;
        }

        container.innerHTML = notebookMessages.map(msg => {
            const sourceTags = (msg.meta && msg.meta.sources ? msg.meta.sources : [])
                .map(s => `<span class="source-tag">${escapeHtml(s.title || s.id)}</span>`)
                .join('');
            const metaLine = `${msg.role === 'user' ? 'Bạn' : 'Notebook'} · ${msg.time ? msg.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}`;
            return `
                <div class="chat-bubble ${msg.role === 'user' ? 'user' : 'bot'}">
                    <div class="chat-meta">
                        <span>${metaLine}</span>
                        ${msg.meta && msg.meta.mock ? '<span class="source-tag">Mock</span>' : ''}
                    </div>
                    ${sourceTags ? `<div class="chat-meta">${sourceTags}</div>` : ''}
                    <div class="chat-content">${formatNotebookText(msg.content)}</div>
                </div>
            `;
        }).join('');

        container.scrollTop = container.scrollHeight;
    }

    function generateNotebookMock(payload) {
        const action = payload.action || 'chat';
        const prompt = typeof payload.prompt === 'string' ? payload.prompt : '';
        const sourceCount = payload.sources ? payload.sources.length : 0;
        const sourceLine = sourceCount > 0 ? ` Dựa trên ${sourceCount} nguồn đã chọn.` : ' (Chưa có nguồn, trả lời chung).';
        switch (action) {
            case 'summary':
                return `Tóm tắt nhanh: ${prompt || 'đang tạo tóm tắt'}${sourceLine}\n• 3-5 ý chính\n• Insight nổi bật\n• Việc cần làm tiếp theo`;
            case 'mindmap':
                return `Mindmap (dạng bullet):\n- Chủ đề chính\n  - Nhánh A\n    - Ý 1\n  - Nhánh B\n    - Ý 2${sourceLine}`;
            case 'flashcards':
                return `Flashcards (mock):\n1) Hỏi: Khái niệm chính là gì?\n   Đáp: Tóm tắt gọn.\n2) Hỏi: Điểm quan trọng?\n   Đáp: ...${sourceLine}`;
            case 'report':
                return `Báo cáo ngắn:\n- Mở đầu\n- 3 phát hiện chính\n- Rủi ro\n- Khuyến nghị${sourceLine}`;
            case 'quiz':
                return `Bài kiểm tra (mock):\n1. Câu hỏi?\nA. ... B. ... C. ... D. ...\n2. Câu hỏi?\n...${sourceLine}`;
            default:
                return `Đây là phản hồi mô phỏng từ API_AI_NOTEBOOK cho prompt: "${prompt.slice(0, 180)}"${sourceLine}`;
        }
    }

    async function callNotebookApi(payload) {
        try {
            const response = await fetch(NOTEBOOK_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...NOTEBOOK_HEADERS },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error('API_AI_NOTEBOOK chưa sẵn sàng');
            }
            const data = await response.json();
            return {
                content: data.content || data.result || '',
                sources: data.sources || payload.sources || [],
                mock: false
            };
        } catch (error) {
            return {
                content: generateNotebookMock(payload),
                sources: payload.sources || [],
                mock: true
            };
        }
    }

    async function sendNotebookPrompt() {
        const input = document.getElementById('notebookPrompt');
        if (!input) return;
        const promptText = (input.value || '').trim();
        if (!promptText) {
            alert('Vui lòng nhập yêu cầu');
            return;
        }
        const sources = selectedNotebookSources();
        appendNotebookMessage('user', promptText, { sources });
        input.value = '';
        showLoadingOverlay(true, 'Đang gửi đến API_AI_NOTEBOOK...');
        try {
            const result = await callNotebookApi({
                action: 'chat',
                prompt: promptText,
                sources
            });
            appendNotebookMessage('bot', result.content, { sources: result.sources, mock: result.mock });
        } catch (error) {
            appendNotebookMessage('bot', 'Không thể gọi API_AI_NOTEBOOK: ' + error.message, { sources, mock: true });
        } finally {
            showLoadingOverlay(false);
        }
    }

    const studioPrompts = {
        summary: 'Tóm tắt ngắn gọn (5 bullet) + insight chính + hành động kế tiếp.',
        mindmap: 'Trả về dàn ý bullet dạng mindmap: chủ đề > nhánh > ý chi tiết.',
        flashcards: 'Sinh 6 flashcards (Hỏi/Đáp) từ nội dung.',
        report: 'Viết báo cáo 1 trang: Mở đầu, Phát hiện, Rủi ro, Khuyến nghị.',
        quiz: 'Tạo 5 câu trắc nghiệm, mỗi câu 4 lựa chọn, đánh dấu đáp án đúng.'
    };

    async function triggerNotebookStudio(action) {
        const sources = selectedNotebookSources();
        if (sources.length === 0) {
            alert('Chọn ít nhất một nguồn để chạy Studio');
            return;
        }
        const prompt = studioPrompts[action] || 'Sinh nội dung dựa trên nguồn đã chọn.';
        showLoadingOverlay(true, 'Đang xử lý Studio...');
        try {
            const result = await callNotebookApi({
                action,
                prompt,
                sources
            });
            renderNotebookStudio(result.content, action, result.mock);
            appendNotebookMessage('bot', `[Studio] ${action}: hoàn thành`, { sources, mock: result.mock });
        } catch (error) {
            renderNotebookStudio('Không thể gọi API_AI_NOTEBOOK: ' + error.message, action, true);
        } finally {
            showLoadingOverlay(false);
        }
    }

    function renderNotebookStudio(content, action = 'Kết quả', isMock = false) {
        const container = document.getElementById('notebookStudioResult');
        const body = document.getElementById('notebookStudioBody');
        const title = document.getElementById('studioResultTitle');
        if (!container || !body || !title) return;
        title.textContent = `Kết quả: ${action}`;
        body.innerHTML = formatNotebookText(content || 'Chưa có nội dung');
        container.classList.remove('hidden');
        notebookStudioAction = action;
        if (isMock) {
            title.textContent += ' (mock)';
        }
    }

    function clearNotebookStudio() {
        const container = document.getElementById('notebookStudioResult');
        const body = document.getElementById('notebookStudioBody');
        if (container) container.classList.add('hidden');
        if (body) body.innerHTML = '';
        notebookStudioAction = null;
    }

    function clearNotebookUI() {
        clearNotebookStudio();
        notebookMessages = [];
        renderNotebookMessages();
    }

    document.addEventListener('DOMContentLoaded', () => {
        switchMode('classic');
        openHome();
        
        const guidelineCheckbox = document.getElementById('enableGuideline');
        if (guidelineCheckbox) {
            guidelineCheckbox.addEventListener('change', () => {
                const options = document.getElementById('guidelineOptions');
                options.classList.toggle('hidden', !guidelineCheckbox.checked);
            });
        }

        const customFormatCheckbox = document.getElementById('applyGuidelineFormatting');
        if (customFormatCheckbox) {
            customFormatCheckbox.addEventListener('change', () => {
                const options = document.getElementById('guidelineFormatOptions');
                options.classList.toggle('hidden', !customFormatCheckbox.checked);
            });
        }

        const templateTextarea = document.getElementById('customTemplate');
        if (templateTextarea) {
            templateTextarea.addEventListener('change', () => {
                extractVariablesFromTemplate(templateTextarea.value);
            });
        }

        const guidelineInput = document.getElementById('guidelineFileInput');
        if (guidelineInput) {
            guidelineInput.addEventListener('change', () => {
                resetGuidelineFlow();
                updateGuidelineFileInfo('guidelineFileInput', 'guidelineFileInfo');
                handleGuidelineFileInput();
            });
        }

        setupGuidelineUploadArea('guidelineUploadArea', 'guidelineFileInput');

        const notebookInput = document.getElementById('notebookFileInput');
        if (notebookInput) {
            notebookInput.addEventListener('change', handleNotebookFileChange);
        }
        const addSourceBtn = document.getElementById('notebookAddSourceBtn');
        if (addSourceBtn && notebookInput) {
            addSourceBtn.addEventListener('click', () => notebookInput.click());
        }

        renderNotebookSources();
        renderNotebookMessages();
    });
</script>
