<script>
    let currentMode = 'classic';
    let currentFiles = {};
    let currentTemplate = null;
    let templateVariables = {};

    function clearGuidelineStatus() {
        const status = document.getElementById('guidelineStatus');
        if (status) {
            status.textContent = '';
            status.className = 'status hidden';
        }
        const download = document.getElementById('guidelineDownloadSection');
        if (download) {
            download.classList.add('hidden');
        }
        const link = document.getElementById('guidelineDownloadLink');
        if (link) {
            link.href = '#';
            link.textContent = '⬇️ Tải file kết quả';
            link.removeAttribute('download');
        }
    }

    function showGuidelineStatus(message, type = 'info') {
        const status = document.getElementById('guidelineStatus');
        if (!status) return;
        status.textContent = message;
        status.className = `status ${type}`;
    }

    function handleGuidelineSuccess(result) {
        showGuidelineStatus('✓ Chuyển đổi Guideline thành công!', 'success');
        const download = document.getElementById('guidelineDownloadSection');
        const link = document.getElementById('guidelineDownloadLink');
        if (download && link && result.download_url) {
            const fileName = result.file_saved || 'output.md';
            link.href = result.download_url;
            link.setAttribute('download', fileName);
            link.textContent = `⬇️ Tải ${fileName}`;
            download.classList.remove('hidden');
        }
    }

    function resetGuidelineFlow() {
        clearGuidelineStatus();
        currentTemplate = null;
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        const formatInput = document.getElementById('formatTextPreview');
        if (formatInput) {
            formatInput.value = '';
        }
        const formattingResult = document.getElementById('formattingResult');
        if (formattingResult) {
            formattingResult.classList.add('hidden');
        }
        const formattingPreview = document.getElementById('formattingPreview');
        if (formattingPreview) {
            formattingPreview.innerHTML = '';
        }
    }

    function updateGuidelineFileInfo(inputId, infoId) {
        const input = document.getElementById(inputId);
        const info = document.getElementById(infoId);
        if (!input || !info || !input.files || input.files.length === 0) {
            if (info) {
                info.textContent = '';
                info.classList.add('hidden');
            }
            return false;
        }
        const file = input.files[0];
        const sizeKb = (file.size / 1024).toFixed(1);
        info.textContent = `✓ ${file.name} (${sizeKb} KB)`;
        info.classList.remove('hidden');
        return true;
    }

    function setupGuidelineUploadArea(areaId, inputId) {
        const area = document.getElementById(areaId);
        const input = document.getElementById(inputId);
        if (!area || !input) return;

        area.addEventListener('click', () => input.click());

        let dragCounter = 0;
        area.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            area.classList.add('dragover');
        });
        area.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                area.classList.remove('dragover');
            }
        });
        area.addEventListener('dragover', (e) => e.preventDefault());
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            area.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            }
        });
    }
    function clearConvertStatuses() {
        const status = document.getElementById('conversionStatus');
        if (status) {
            status.innerHTML = '';
            status.className = 'status hidden';
        }
        const statusMsg = document.getElementById('statusMsg');
        if (statusMsg) {
            statusMsg.textContent = '';
            statusMsg.className = 'status hidden';
        }
        const downloadSection = document.getElementById('downloadSection');
        if (downloadSection) {
            downloadSection.classList.add('hidden');
        }
    }
    const modeCopy = {
        classic: {
            label: 'Excel Classic',
            desc: 'Tối ưu cho Excel → DOCX.',
            title: 'Excel Classic',
            subtitle: 'Chuyển đổi Excel theo từng bước chi tiết.',
            showSource: true,
            showTarget: true
        },
        universal: {
            label: 'Universal',
            desc: 'Chuyển nhiều định dạng sang Markdown nhanh.',
            title: 'Universal',
            subtitle: 'Chuyển file bất kỳ định dạng sang Markdown.',
            showSource: false,
            showTarget: false
        }
    };

    function ensureConvertContent() {
        const convertScreen = document.getElementById('convertScreen');
        if (!convertScreen || convertScreen.classList.contains('hidden')) {
            return;
        }
        const activeSection = convertScreen.querySelector('.mode-section.active:not(.hidden)');
        if (!activeSection) {
            const fallback = currentMode && modeCopy[currentMode] ? currentMode : 'classic';
            switchMode(fallback);
        }
    }

    function setActiveScreen(screenId) {
        const screens = ['homeScreen', 'modeSelectScreen', 'convertScreen', 'guidelineScreen'];
        screens.forEach(id => {
            const screen = document.getElementById(id);
            if (!screen) {
                return;
            }
            const isActive = id === screenId;
            screen.classList.toggle('active', isActive);
            screen.classList.toggle('hidden', !isActive);
        });

        if (screenId === 'convertScreen') {
            ensureConvertContent();
        }
    }

    function openHome() {
        currentMode = null;
        clearConvertStatuses();
        clearGuidelineStatus();
        setActiveScreen('homeScreen');
    }

    function openModeSelect() {
        setActiveScreen('modeSelectScreen');
    }

    function openConvertFlow(mode) {
        const targetMode = modeCopy[mode] ? mode : 'classic';
        currentMode = targetMode;
        clearConvertStatuses();
        setActiveScreen('convertScreen');
        switchMode(targetMode);
    }

    function openGuidelineAi(tab = 'guideline') {
        setActiveScreen('guidelineScreen');
        clearGuidelineStatus();
        const isGuideline = tab !== 'custom';
        const guidelineMode = document.getElementById('guidelineMode');
        const guidelineTab = document.getElementById('guidelineTabButton');

        if (guidelineMode) {
            guidelineMode.classList.add('active');
            guidelineMode.classList.remove('hidden');
        }
        if (guidelineTab) {
            guidelineTab.classList.add('active');
        }
    }

    function updateConvertLabels(mode) {
        const copy = modeCopy[mode] || modeCopy.classic;
        const label = document.getElementById('activeModeLabel');
        const desc = document.getElementById('activeModeDesc');
        const flowTitle = document.getElementById('convertFlowTitle');
        const flowSubtitle = document.getElementById('convertFlowSubtitle');
        const headerTitle = document.getElementById('convertTitle');
        const headerSubtitle = document.getElementById('convertSubtitle');
        const sourceGroup = document.getElementById('sourceFormatGroup');
        const targetGroup = document.getElementById('targetFormatGroup');

        if (label) {
            label.textContent = copy.label;
        }
        if (desc) {
            desc.textContent = copy.desc;
        }
        if (flowTitle) {
            flowTitle.textContent = copy.title;
        }
        if (flowSubtitle) {
            flowSubtitle.textContent = copy.subtitle;
        }
        if (headerTitle) {
            headerTitle.textContent = copy.title;
        }
        if (headerSubtitle) {
            headerSubtitle.textContent = copy.subtitle;
        }
        if (sourceGroup) {
            sourceGroup.classList.toggle('hidden', !copy.showSource);
        }
        if (targetGroup) {
            targetGroup.classList.toggle('hidden', !copy.showTarget);
        }
    }

    function switchMode(mode) {
        if (mode === 'guideline' || mode === 'custom') {
            openGuidelineAi(mode);
            return;
        }

        currentMode = modeCopy[mode] ? mode : 'classic';
        clearConvertStatuses();
        
        document.querySelectorAll('.mode-section').forEach(el => {
            el.classList.remove('active');
            el.classList.add('hidden');
        });
        
        const modeId = currentMode + 'Mode';
        let modeElement = document.getElementById(modeId);
        if (!modeElement) {
            currentMode = 'classic';
            modeElement = document.getElementById('classicMode');
        }
        if (modeElement) {
            modeElement.classList.add('active');
            modeElement.classList.remove('hidden');
        }

        updateConvertLabels(currentMode);
    }

    function goToStep(stepId) {
        const container = document.getElementById('guidelineMode');
        if (!container) return;
        container.querySelectorAll('.step').forEach(el => {
            el.classList.remove('active');
        });
        const step = container.querySelector('#' + stepId);
        if (step) step.classList.add('active');
    }

    function handleGuidelineFileInput() {
        const input = document.getElementById('guidelineFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        if (!updateGuidelineFileInfo('guidelineFileInput', 'guidelineFileInfo')) {
            return;
        }
        resetGuidelineFlow();
        currentFiles.guideline = file;
        goToStep('guideline-step-2');
    }

    function handleCustomFileInput() {
        const input = document.getElementById('customFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        currentFiles.custom = file;
        goToStep('custom-step-2');
    }

    function selectTemplate(templateType, el) {
        currentTemplate = templateType;
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        el.classList.add('selected');
    }

    async function previewGuidelineFormatting() {
        const text = document.getElementById('formatTextPreview').value;
        if (!text) {
            alert('Vui lòng nhập text để xem preview');
            return;
        }

        try {
            const response = await fetch('/api/v2/format/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(text)
            });

            if (!response.ok) {
                throw new Error('Lỗi định dạng text');
            }

            const result = await response.json();
            const preview = document.getElementById('formattingPreview');
            preview.innerHTML = marked.parse(result.formatted_text);
            document.getElementById('formattingResult').classList.remove('hidden');
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        }
    }

    async function convertWithGuideline() {
        if (!currentFiles.guideline) {
            alert('Vui lòng chọn file');
            return;
        }

        if (!currentTemplate) {
            alert('Vui lòng chọn loại template');
            return;
        }

        clearGuidelineStatus();
        showLoadingOverlay(true, `Đang chuyển đổi với Template ${currentTemplate}...`);

        try {
            const uploadForm = new FormData();
            uploadForm.append('file', currentFiles.guideline);

            const uploadResponse = await fetch('/api/v2/upload', {
                method: 'POST',
                body: uploadForm
            });

            const uploadData = await uploadResponse.json();
            if (!uploadResponse.ok) {
                const detail = uploadData.detail || uploadData.error || 'Lỗi upload';
                throw new Error(detail);
            }

            const response = await fetch('/api/v2/convert/guideline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: uploadData.filename,
                    template_type: currentTemplate
                })
            });

            const result = await response.json();
            if (!response.ok) {
                const detail = result.detail || result.error || 'Lỗi chuyển đổi';
                throw new Error(detail);
            }

            handleGuidelineSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            showGuidelineStatus('Lỗi: ' + error.message, 'error');
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function loadPredefinedTemplate() {
        const select = document.getElementById('predefinedTemplateSelect') || document.getElementById('customTemplateSelect');
        if (!select) {
            return;
        }
        const templateKey = select.value;

        if (!templateKey) {
            document.getElementById('customTemplate').value = '';
            return;
        }

        try {
            const response = await fetch(`/api/v2/predefined-template?template_type=${templateKey}`);
            if (!response.ok) {
                throw new Error('Không thể tải template');
            }

            const result = await response.json();
            document.getElementById('customTemplate').value = result.template;
            extractVariablesFromTemplate(result.template);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        }
    }

    function extractVariablesFromTemplate(template) {
        const variableRegex = /\{\{([A-Z_]+)\}\}/g;
        const variables = new Set();
        let match;

        while ((match = variableRegex.exec(template)) !== null) {
            variables.add(match[1]);
        }

        templateVariables = {};
        variables.forEach(v => {
            templateVariables[v] = '';
        });

        renderVariablesInputs();
    }

    function renderVariablesInputs() {
        const container = document.getElementById('variablesInputs');
        container.innerHTML = '';

        const listContainer = document.getElementById('variablesList');
        listContainer.innerHTML = '';
        Object.keys(templateVariables).forEach(varName => {
            const tag = document.createElement('span');
            tag.className = 'variable-tag';
            tag.textContent = '{{' + varName + '}}';
            listContainer.appendChild(tag);
        });

        Object.keys(templateVariables).forEach(varName => {
            const group = document.createElement('div');
            group.className = 'variable-input-group';
            group.innerHTML = '<label for="var_' + varName + '">{{' + varName + '}}</label>' +
                '<textarea id="var_' + varName + '" placeholder="Nhập giá trị cho ' + varName + '"></textarea>';
            container.appendChild(group);
        });
    }

    async function convertWithCustomTemplate() {
        if (!currentFiles.custom) {
            alert('Vui lòng chọn file');
            return;
        }

        const templateText = document.getElementById('customTemplate').value;
        if (!templateText) {
            alert('Vui lòng nhập hoặc chọn template');
            return;
        }

        const variables = {};
        Object.keys(templateVariables).forEach(varName => {
            const input = document.getElementById('var_' + varName);
            if (input) {
                variables[varName] = input.value || '';
            }
        });

        const formData = new FormData();
        formData.append('file', currentFiles.custom);
        formData.append('template', templateText);
        formData.append('variables', JSON.stringify(variables));
        formData.append('apply_guideline', document.getElementById('applyGuidelineFormatting').checked);

        showLoadingOverlay(true, 'Đang chuyển đổi với Custom Template...');

        try {
            const response = await fetch('/api/v2/convert-with-custom-template', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Lỗi chuyển đổi');
            }

            const result = await response.json();
            handleConversionSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        } finally {
            showLoadingOverlay(false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        switchMode('classic');
        openHome();
        
        const guidelineCheckbox = document.getElementById('enableGuideline');
        if (guidelineCheckbox) {
            guidelineCheckbox.addEventListener('change', () => {
                const options = document.getElementById('guidelineOptions');
                options.classList.toggle('hidden', !guidelineCheckbox.checked);
            });
        }

        const customFormatCheckbox = document.getElementById('applyGuidelineFormatting');
        if (customFormatCheckbox) {
            customFormatCheckbox.addEventListener('change', () => {
                const options = document.getElementById('guidelineFormatOptions');
                options.classList.toggle('hidden', !customFormatCheckbox.checked);
            });
        }

        const templateTextarea = document.getElementById('customTemplate');
        if (templateTextarea) {
            templateTextarea.addEventListener('change', () => {
                extractVariablesFromTemplate(templateTextarea.value);
            });
        }

        const guidelineInput = document.getElementById('guidelineFileInput');
        if (guidelineInput) {
            guidelineInput.addEventListener('change', () => {
                resetGuidelineFlow();
                updateGuidelineFileInfo('guidelineFileInput', 'guidelineFileInfo');
                handleGuidelineFileInput();
            });
        }

        setupGuidelineUploadArea('guidelineUploadArea', 'guidelineFileInput');
    });
</script>
