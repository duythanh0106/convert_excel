version: '3.8'

services:
  excel-converter:
    build: .
    image: excel-converter:latest
    container_name: excel-converter-app

    ports:
      - "8080:8080"

    volumes:
      - uploads_data:/app/uploads
      - outputs_data:/app/outputs

    environment:
      - FASTAPI_ENV=production
      - MAX_FILE_SIZE=52428800
      - CLEANUP_HOURS=24
      - TZ=Asia/Ho_Chi_Minh

    mem_limit: 2g
    cpus: 2.0

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - excel-network

  nginx:
    image: nginx:alpine
    container_name: excel-converter-nginx
    profiles: ["with-nginx"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - excel-converter
    restart: unless-stopped
    networks:
      - excel-network

networks:
  excel-network:
    driver: bridge

volumes:
  uploads_data:
  outputs_data:
