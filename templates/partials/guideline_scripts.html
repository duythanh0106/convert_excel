<script>
    let currentMode = 'classic';
    let currentFiles = {};
    let currentTemplate = null;
    let templateVariables = {};

    const modeCopy = {
        classic: {
            label: 'Excel Classic',
            desc: 'Tối ưu cho Excel → DOCX.',
            title: 'Excel Classic',
            subtitle: 'Chuyển đổi Excel theo từng bước chi tiết.',
            showSource: true,
            showTarget: true
        },
        universal: {
            label: 'Universal',
            desc: 'Chuyển nhiều định dạng sang Markdown nhanh.',
            title: 'Universal',
            subtitle: 'Chuyển file bất kỳ định dạng sang Markdown.',
            showSource: false,
            showTarget: false
        }
    };

    function setActiveScreen(screenId) {
        const screens = ['homeScreen', 'modeSelectScreen', 'convertScreen', 'guidelineScreen'];
        screens.forEach(id => {
            const screen = document.getElementById(id);
            if (!screen) {
                return;
            }
            const isActive = id === screenId;
            screen.classList.toggle('active', isActive);
            screen.classList.toggle('hidden', !isActive);
        });
    }

    function openHome() {
        setActiveScreen('homeScreen');
    }

    function openModeSelect() {
        setActiveScreen('modeSelectScreen');
    }

    function openConvertFlow(mode) {
        setActiveScreen('convertScreen');
        switchMode(mode);
    }

    function openGuidelineAi(tab = 'guideline') {
        setActiveScreen('guidelineScreen');
        const isGuideline = tab !== 'custom';
        const guidelineMode = document.getElementById('guidelineMode');
        const guidelineTab = document.getElementById('guidelineTabButton');

        if (guidelineMode) {
            guidelineMode.classList.add('active');
            guidelineMode.classList.remove('hidden');
        }
        if (guidelineTab) {
            guidelineTab.classList.add('active');
        }
    }

    function updateConvertLabels(mode) {
        const copy = modeCopy[mode] || modeCopy.classic;
        const label = document.getElementById('activeModeLabel');
        const desc = document.getElementById('activeModeDesc');
        const flowTitle = document.getElementById('convertFlowTitle');
        const flowSubtitle = document.getElementById('convertFlowSubtitle');
        const headerTitle = document.getElementById('convertTitle');
        const headerSubtitle = document.getElementById('convertSubtitle');
        const sourceGroup = document.getElementById('sourceFormatGroup');
        const targetGroup = document.getElementById('targetFormatGroup');

        if (label) {
            label.textContent = copy.label;
        }
        if (desc) {
            desc.textContent = copy.desc;
        }
        if (flowTitle) {
            flowTitle.textContent = copy.title;
        }
        if (flowSubtitle) {
            flowSubtitle.textContent = copy.subtitle;
        }
        if (headerTitle) {
            headerTitle.textContent = copy.title;
        }
        if (headerSubtitle) {
            headerSubtitle.textContent = copy.subtitle;
        }
        if (sourceGroup) {
            sourceGroup.classList.toggle('hidden', !copy.showSource);
        }
        if (targetGroup) {
            targetGroup.classList.toggle('hidden', !copy.showTarget);
        }
    }

    function switchMode(mode) {
        if (mode === 'guideline' || mode === 'custom') {
            openGuidelineAi(mode);
            return;
        }

        currentMode = mode;
        
        document.querySelectorAll('.mode-section').forEach(el => {
            el.classList.remove('active');
            el.classList.add('hidden');
        });
        
        const modeId = mode + 'Mode';
        const modeElement = document.getElementById(modeId);
        if (modeElement) {
            modeElement.classList.add('active');
            modeElement.classList.remove('hidden');
        }

        updateConvertLabels(mode);
    }

    function goToStep(stepId) {
        document.querySelectorAll('.step').forEach(el => {
            el.classList.remove('active');
        });
        const step = document.getElementById(stepId);
        if (step) {
            step.classList.add('active');
        }
    }

    function handleUniversalFileInput() {
        const input = document.getElementById('universalFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        currentFiles.universal = file;
    }

    function handleGuidelineFileInput() {
        const input = document.getElementById('guidelineFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        currentFiles.guideline = file;
        goToStep('guideline-step-2');
    }

    function handleCustomFileInput() {
        const input = document.getElementById('customFileInput');
        const file = input.files[0];
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        currentFiles.custom = file;
        goToStep('custom-step-2');
    }

    function selectTemplate(templateType, el) {
        currentTemplate = templateType;
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        el.classList.add('selected');
    }

    async function previewGuidelineFormatting() {
        const text = document.getElementById('formatTextPreview').value;
        if (!text) {
            alert('Vui lòng nhập text để xem preview');
            return;
        }

        try {
            const response = await fetch('/api/v2/format/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(text)
            });

            if (!response.ok) {
                throw new Error('Lỗi định dạng text');
            }

            const result = await response.json();
            const preview = document.getElementById('formattingPreview');
            preview.innerHTML = marked.parse(result.formatted_text);
            document.getElementById('formattingResult').classList.remove('hidden');
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        }
    }

    async function convertWithGuideline() {
        if (!currentFiles.guideline) {
            alert('Vui lòng chọn file');
            return;
        }

        if (!currentTemplate) {
            alert('Vui lòng chọn loại template');
            return;
        }

        showLoadingOverlay(true, `Đang chuyển đổi với Template ${currentTemplate}...`);

        try {
            const uploadForm = new FormData();
            uploadForm.append('file', currentFiles.guideline);

            const uploadResponse = await fetch('/api/v2/upload', {
                method: 'POST',
                body: uploadForm
            });

            const uploadData = await uploadResponse.json();
            if (!uploadResponse.ok) {
                const detail = uploadData.detail || uploadData.error || 'Lỗi upload';
                throw new Error(detail);
            }

            const response = await fetch('/api/v2/convert/guideline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: uploadData.filename,
                    template_type: currentTemplate
                })
            });

            const result = await response.json();
            if (!response.ok) {
                const detail = result.detail || result.error || 'Lỗi chuyển đổi';
                throw new Error(detail);
            }

            handleConversionSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function loadPredefinedTemplate() {
        const select = document.getElementById('predefinedTemplateSelect') || document.getElementById('customTemplateSelect');
        if (!select) {
            return;
        }
        const templateKey = select.value;

        if (!templateKey) {
            document.getElementById('customTemplate').value = '';
            return;
        }

        try {
            const response = await fetch(`/api/v2/predefined-template?template_type=${templateKey}`);
            if (!response.ok) {
                throw new Error('Không thể tải template');
            }

            const result = await response.json();
            document.getElementById('customTemplate').value = result.template;
            extractVariablesFromTemplate(result.template);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        }
    }

    function extractVariablesFromTemplate(template) {
        const variableRegex = /\{\{([A-Z_]+)\}\}/g;
        const variables = new Set();
        let match;

        while ((match = variableRegex.exec(template)) !== null) {
            variables.add(match[1]);
        }

        templateVariables = {};
        variables.forEach(v => {
            templateVariables[v] = '';
        });

        renderVariablesInputs();
    }

    function renderVariablesInputs() {
        const container = document.getElementById('variablesInputs');
        container.innerHTML = '';

        const listContainer = document.getElementById('variablesList');
        listContainer.innerHTML = '';
        Object.keys(templateVariables).forEach(varName => {
            const tag = document.createElement('span');
            tag.className = 'variable-tag';
            tag.textContent = '{{' + varName + '}}';
            listContainer.appendChild(tag);
        });

        Object.keys(templateVariables).forEach(varName => {
            const group = document.createElement('div');
            group.className = 'variable-input-group';
            group.innerHTML = '<label for="var_' + varName + '">{{' + varName + '}}</label>' +
                '<textarea id="var_' + varName + '" placeholder="Nhập giá trị cho ' + varName + '"></textarea>';
            container.appendChild(group);
        });
    }

    async function convertWithCustomTemplate() {
        if (!currentFiles.custom) {
            alert('Vui lòng chọn file');
            return;
        }

        const templateText = document.getElementById('customTemplate').value;
        if (!templateText) {
            alert('Vui lòng nhập hoặc chọn template');
            return;
        }

        const variables = {};
        Object.keys(templateVariables).forEach(varName => {
            const input = document.getElementById('var_' + varName);
            if (input) {
                variables[varName] = input.value || '';
            }
        });

        const formData = new FormData();
        formData.append('file', currentFiles.custom);
        formData.append('template', templateText);
        formData.append('variables', JSON.stringify(variables));
        formData.append('apply_guideline', document.getElementById('applyGuidelineFormatting').checked);

        showLoadingOverlay(true, 'Đang chuyển đổi với Custom Template...');

        try {
            const response = await fetch('/api/v2/convert-with-custom-template', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Lỗi chuyển đổi');
            }

            const result = await response.json();
            handleConversionSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function convertUniversal() {
        const input = document.getElementById('universalFileInput');
        const file = input ? input.files[0] : null;
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        currentFiles.universal = file;

        showLoadingOverlay(true, 'Đang tải file và chuyển đổi...');

        try {
            const uploadForm = new FormData();
            uploadForm.append('file', currentFiles.universal);

            const uploadResponse = await fetch('/api/v2/upload', {
                method: 'POST',
                body: uploadForm
            });

            const uploadData = await uploadResponse.json();

            if (!uploadResponse.ok) {
                const detail = uploadData.detail || uploadData.error || 'Lỗi upload';
                throw new Error(detail);
            }

            const convertResponse = await fetch('/api/v2/convert/markdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: uploadData.filename,
                    output_format: 'markdown'
                })
            });

            const result = await convertResponse.json();

            if (!convertResponse.ok) {
                const detail = result.detail || result.error || 'Lỗi chuyển đổi';
                throw new Error(detail);
            }

            handleConversionSuccess(result);
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi: ' + error.message);
        } finally {
            showLoadingOverlay(false);
        }
    }

    function handleConversionSuccess(result) {
        const status = document.getElementById('conversionStatus');
        status.className = 'status success';
        status.innerHTML = `
            <strong>✓ Chuyển đổi thành công!</strong><br/>
            Tệp: ` + (result.output_file || 'output') + `<br/>
            <a href="` + result.download_url + `" download class="btn btn-success" style="margin-top: 10px; display: inline-block;">
                ⬇️ Tải xuống
            </a>
        `;
    }

    function showLoadingOverlay(show, message = '') {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            if (message) {
                document.querySelector('.loading-text').textContent = message;
            }
            overlay.classList.add('active');
        } else {
            overlay.classList.remove('active');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        switchMode('classic');
        openHome();
        
        const guidelineCheckbox = document.getElementById('enableGuideline');
        if (guidelineCheckbox) {
            guidelineCheckbox.addEventListener('change', () => {
                const options = document.getElementById('guidelineOptions');
                options.classList.toggle('hidden', !guidelineCheckbox.checked);
            });
        }

        const customFormatCheckbox = document.getElementById('applyGuidelineFormatting');
        if (customFormatCheckbox) {
            customFormatCheckbox.addEventListener('change', () => {
                const options = document.getElementById('guidelineFormatOptions');
                options.classList.toggle('hidden', !customFormatCheckbox.checked);
            });
        }

        const templateTextarea = document.getElementById('customTemplate');
        if (templateTextarea) {
            templateTextarea.addEventListener('change', () => {
                extractVariablesFromTemplate(templateTextarea.value);
            });
        }
    });
</script>
